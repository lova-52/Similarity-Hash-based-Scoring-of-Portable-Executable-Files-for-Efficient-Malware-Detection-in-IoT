from tabulate import tabulate
from utils.hash_similarity import *
from utils.data_loader import *
from utils.tlbsa import *

def main():
    # Load datasets
    dataset_I = load_dataset('DatasetI.csv')
    dataset_II = load_dataset('DatasetII.csv')

    #Get total samples of both datasets
    total_sameples_I = len(dataset_I)
    total_sameples_II = len(dataset_II)

    # Calculate detection rates
    print("Calculating det rates: ")
    det_rates = calculate_det_rates(dataset_I, dataset_II)
    # Print detection rates
    print("Detection rates:") 
    print(det_rates)

    # Calculate CFI value for the hash methods
    print("Calculating CFI value: ")
    cfi = calculate_cfi(det_rates, total_sameples_II)

    # Calculate Recall value for the hash methods
    recall = calculate_recall(det_rates)

    # Calculate PPV value for the hash methods
    ppv = calculate_ppv(det_rates)

    # Calculate ACC value for the hash methods
    acc = calculate_acc(det_rates)

    # Calculate F1 value for the hash methods
    f1 = calculate_f1(det_rates)

    # Calculate TDR value for the hash methods
    tdr = calculate_tdr(det_rates, total_sameples_II)

    # Calculate FDR value for the hash methods
    fdr = calculate_fdr(det_rates, total_sameples_II)
    
    # Format results as table
    headers = ["Method", "Recall", "PPV", "ACC", "F1", "TDR", "FDR", "CFI"]
    table = []
    for method in det_rates.keys():
        row = [
            method,
            recall[method],
            ppv[method],
            acc[method],
            f1[method],
            tdr[method],
            fdr[method],
            cfi[method]
        ]
        table.append(row)
    print(tabulate(table, headers=headers))

    #Calculate TLBSA Thresholds
    calculate_tlbsa(det_rates, cfi, dataset_I, dataset_II)

if __name__ == "__main__":
    main()



#Calculating det rates:
#{'Imp_H': [19497, 2632, 562, 519], 'Pe_H': [11044, 11085, 362, 719], 'Sd_H': [18693, 3436, 552, 529], 'RSd_H': [20695, 1434, 995, 86]}
#Press any key to continue...

#Calculating CFI value:
#Method      Recall    PPV    ACC    F1    TDR    FDR    CFI
#--------  --------  -----  -----  ----  -----  -----  -----
#Imp_H        0.881  0.972  0.864   0.9  0.864  0.136  0.279
#Pe_H         0.499  0.968  0.491   0.7  0.491  0.509  0.164
#Sd_H         0.845  0.971  0.829   0.9  0.829  0.171  0.268
#RSd_H        0.935  0.954  0.935   0.9  0.935  0.065  0.29

#Fuzzy logic algebraic sum =  0.9988859830078912
#Certainty Factor Model algebraic sum =  0.9993385850008095